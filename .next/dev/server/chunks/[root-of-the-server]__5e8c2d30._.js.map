{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/jsonDb.ts"],"sourcesContent":["import fs from \"fs/promises\";\r\nimport path from \"path\";\r\n\r\nconst dataRoot = path.join(process.cwd(), \"src\", \"data\");\r\n\r\n// Simple lock mechanism to prevent concurrent writes\r\nconst locks = new Map<string, Promise<void>>();\r\n\r\nexport function getDataFilePath(fileName: string) {\r\n  return path.join(dataRoot, fileName);\r\n}\r\n\r\nexport async function readJsonFile<T>(fileName: string): Promise<T> {\r\n  const filePath = getDataFilePath(fileName);\r\n  const fileContents = await fs.readFile(filePath, \"utf-8\");\r\n  return JSON.parse(fileContents) as T;\r\n}\r\n\r\nexport async function writeJsonFile<T>(fileName: string, data: T) {\r\n  const filePath = getDataFilePath(fileName);\r\n\r\n  // Wait for any existing write operation to complete\r\n  while (locks.has(fileName)) {\r\n    await locks.get(fileName);\r\n  }\r\n\r\n  // Create a new lock for this write operation\r\n  const writeLock = (async () => {\r\n    try {\r\n      const jsonString = JSON.stringify(data, null, 2);\r\n\r\n      // Validate JSON before writing\r\n      try {\r\n        JSON.parse(jsonString);\r\n      } catch (error) {\r\n        console.error(\"Invalid JSON data, aborting write:\", error);\r\n        throw new Error(\"Failed to write JSON: Invalid data structure\");\r\n      }\r\n\r\n      // Write to temporary file first, then rename (atomic operation)\r\n      const tempFilePath = `${filePath}.tmp`;\r\n      await fs.writeFile(tempFilePath, jsonString, \"utf-8\");\r\n      await fs.rename(tempFilePath, filePath);\r\n    } finally {\r\n      locks.delete(fileName);\r\n    }\r\n  })();\r\n\r\n  locks.set(fileName, writeLock);\r\n  await writeLock;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEA,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,OAAO;AAEjD,qDAAqD;AACrD,MAAM,QAAQ,IAAI;AAEX,SAAS,gBAAgB,QAAgB;IAC9C,OAAO,4GAAI,CAAC,IAAI,CAAC,UAAU;AAC7B;AAEO,eAAe,aAAgB,QAAgB;IACpD,MAAM,WAAW,gBAAgB;IACjC,MAAM,eAAe,MAAM,gIAAE,CAAC,QAAQ,CAAC,UAAU;IACjD,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,cAAiB,QAAgB,EAAE,IAAO;IAC9D,MAAM,WAAW,gBAAgB;IAEjC,oDAAoD;IACpD,MAAO,MAAM,GAAG,CAAC,UAAW;QAC1B,MAAM,MAAM,GAAG,CAAC;IAClB;IAEA,6CAA6C;IAC7C,MAAM,YAAY,CAAC;QACjB,IAAI;YACF,MAAM,aAAa,KAAK,SAAS,CAAC,MAAM,MAAM;YAE9C,+BAA+B;YAC/B,IAAI;gBACF,KAAK,KAAK,CAAC;YACb,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,sCAAsC;gBACpD,MAAM,IAAI,MAAM;YAClB;YAEA,gEAAgE;YAChE,MAAM,eAAe,GAAG,SAAS,IAAI,CAAC;YACtC,MAAM,gIAAE,CAAC,SAAS,CAAC,cAAc,YAAY;YAC7C,MAAM,gIAAE,CAAC,MAAM,CAAC,cAAc;QAChC,SAAU;YACR,MAAM,MAAM,CAAC;QACf;IACF,CAAC;IAED,MAAM,GAAG,CAAC,UAAU;IACpB,MAAM;AACR"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/app/api/messages/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { readJsonFile, writeJsonFile } from \"@/lib/jsonDb\";\r\n\r\ninterface AuditorMessage {\r\n  id: string;\r\n  facultyId: string;\r\n  auditorId?: string;\r\n  entityType: \"course-file\" | \"event-report\" | string;\r\n  entityId: string;\r\n  threadId?: string;\r\n  senderRole?: \"auditor\" | \"faculty\" | string;\r\n  senderName?: string;\r\n  message: string;\r\n  status?: string;\r\n  createdAt?: string;\r\n  updatedAt?: string;\r\n}\r\n\r\nconst resolveThreadId = (message: AuditorMessage) =>\r\n  message.threadId ?? `${message.entityType}:${message.entityId}`;\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const facultyId = request.nextUrl.searchParams.get(\"facultyId\");\r\n    const auditorId = request.nextUrl.searchParams.get(\"auditorId\");\r\n    const threadId = request.nextUrl.searchParams.get(\"threadId\");\r\n    const messages = await readJsonFile<AuditorMessage[]>(\r\n      \"auditorMessages.json\",\r\n    );\r\n    let filtered = messages;\r\n    if (facultyId) {\r\n      filtered = filtered.filter((msg) => msg.facultyId === facultyId);\r\n    }\r\n    if (auditorId) {\r\n      filtered = filtered.filter((msg) => msg.auditorId === auditorId);\r\n    }\r\n    if (threadId) {\r\n      filtered = filtered.filter((msg) => resolveThreadId(msg) === threadId);\r\n    }\r\n    return NextResponse.json({ messages: filtered });\r\n  } catch (error) {\r\n    console.error(\"Messages load error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to load messages\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const payload = await request.json();\r\n    const messages = await readJsonFile<AuditorMessage[]>(\r\n      \"auditorMessages.json\",\r\n    );\r\n    const timestamp = new Date().toISOString();\r\n\r\n    const newMessage: AuditorMessage = {\r\n      id: Date.now().toString(),\r\n      facultyId: payload.facultyId,\r\n      auditorId: payload.auditorId,\r\n      entityType: payload.entityType,\r\n      entityId: payload.entityId,\r\n      threadId: payload.threadId,\r\n      senderRole: payload.senderRole,\r\n      senderName: payload.senderName,\r\n      message: payload.message ?? \"\",\r\n      status: payload.status,\r\n      createdAt: timestamp,\r\n      updatedAt: timestamp,\r\n    };\r\n\r\n    const updatedMessages = [newMessage, ...messages];\r\n    await writeJsonFile(\"auditorMessages.json\", updatedMessages);\r\n\r\n    return NextResponse.json({ messages: updatedMessages });\r\n  } catch (error) {\r\n    console.error(\"Message create error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to create message\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const threadId = request.nextUrl.searchParams.get(\"threadId\");\r\n    if (!threadId) {\r\n      return NextResponse.json(\r\n        { error: \"threadId is required\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    const messages = await readJsonFile<AuditorMessage[]>(\r\n      \"auditorMessages.json\",\r\n    );\r\n    const updatedMessages = messages.filter(\r\n      (msg) => resolveThreadId(msg) !== threadId,\r\n    );\r\n\r\n    await writeJsonFile(\"auditorMessages.json\", updatedMessages);\r\n\r\n    return NextResponse.json({ messages: updatedMessages });\r\n  } catch (error) {\r\n    console.error(\"Message delete error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to delete messages\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAiBA,MAAM,kBAAkB,CAAC,UACvB,QAAQ,QAAQ,IAAI,GAAG,QAAQ,UAAU,CAAC,CAAC,EAAE,QAAQ,QAAQ,EAAE;AAE1D,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,YAAY,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QACnD,MAAM,YAAY,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QACnD,MAAM,WAAW,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QAClD,MAAM,WAAW,MAAM,IAAA,sIAAY,EACjC;QAEF,IAAI,WAAW;QACf,IAAI,WAAW;YACb,WAAW,SAAS,MAAM,CAAC,CAAC,MAAQ,IAAI,SAAS,KAAK;QACxD;QACA,IAAI,WAAW;YACb,WAAW,SAAS,MAAM,CAAC,CAAC,MAAQ,IAAI,SAAS,KAAK;QACxD;QACA,IAAI,UAAU;YACZ,WAAW,SAAS,MAAM,CAAC,CAAC,MAAQ,gBAAgB,SAAS;QAC/D;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAS;IAChD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA0B,GACnC;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,UAAU,MAAM,QAAQ,IAAI;QAClC,MAAM,WAAW,MAAM,IAAA,sIAAY,EACjC;QAEF,MAAM,YAAY,IAAI,OAAO,WAAW;QAExC,MAAM,aAA6B;YACjC,IAAI,KAAK,GAAG,GAAG,QAAQ;YACvB,WAAW,QAAQ,SAAS;YAC5B,WAAW,QAAQ,SAAS;YAC5B,YAAY,QAAQ,UAAU;YAC9B,UAAU,QAAQ,QAAQ;YAC1B,UAAU,QAAQ,QAAQ;YAC1B,YAAY,QAAQ,UAAU;YAC9B,YAAY,QAAQ,UAAU;YAC9B,SAAS,QAAQ,OAAO,IAAI;YAC5B,QAAQ,QAAQ,MAAM;YACtB,WAAW;YACX,WAAW;QACb;QAEA,MAAM,kBAAkB;YAAC;eAAe;SAAS;QACjD,MAAM,IAAA,uIAAa,EAAC,wBAAwB;QAE5C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAgB;IACvD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA2B,GACpC;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,OAAO,OAAoB;IAC/C,IAAI;QACF,MAAM,WAAW,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QAClD,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuB,GAChC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,WAAW,MAAM,IAAA,sIAAY,EACjC;QAEF,MAAM,kBAAkB,SAAS,MAAM,CACrC,CAAC,MAAQ,gBAAgB,SAAS;QAGpC,MAAM,IAAA,uIAAa,EAAC,wBAAwB;QAE5C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAgB;IACvD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA4B,GACrC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}