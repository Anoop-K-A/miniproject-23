{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/jsonDb.ts"],"sourcesContent":["import fs from \"fs/promises\";\r\nimport path from \"path\";\r\n\r\nconst dataRoot = path.join(process.cwd(), \"src\", \"data\");\r\n\r\n// Simple lock mechanism to prevent concurrent writes\r\nconst locks = new Map<string, Promise<void>>();\r\n\r\nexport function getDataFilePath(fileName: string) {\r\n  return path.join(dataRoot, fileName);\r\n}\r\n\r\nexport async function readJsonFile<T>(fileName: string): Promise<T> {\r\n  const filePath = getDataFilePath(fileName);\r\n  const fileContents = await fs.readFile(filePath, \"utf-8\");\r\n  return JSON.parse(fileContents) as T;\r\n}\r\n\r\nexport async function writeJsonFile<T>(fileName: string, data: T) {\r\n  const filePath = getDataFilePath(fileName);\r\n\r\n  // Wait for any existing write operation to complete\r\n  while (locks.has(fileName)) {\r\n    await locks.get(fileName);\r\n  }\r\n\r\n  // Create a new lock for this write operation\r\n  const writeLock = (async () => {\r\n    try {\r\n      const jsonString = JSON.stringify(data, null, 2);\r\n\r\n      // Validate JSON before writing\r\n      try {\r\n        JSON.parse(jsonString);\r\n      } catch (error) {\r\n        console.error(\"Invalid JSON data, aborting write:\", error);\r\n        throw new Error(\"Failed to write JSON: Invalid data structure\");\r\n      }\r\n\r\n      // Write to temporary file first, then rename (atomic operation)\r\n      const tempFilePath = `${filePath}.tmp`;\r\n      await fs.writeFile(tempFilePath, jsonString, \"utf-8\");\r\n      await fs.rename(tempFilePath, filePath);\r\n    } finally {\r\n      locks.delete(fileName);\r\n    }\r\n  })();\r\n\r\n  locks.set(fileName, writeLock);\r\n  await writeLock;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEA,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,OAAO;AAEjD,qDAAqD;AACrD,MAAM,QAAQ,IAAI;AAEX,SAAS,gBAAgB,QAAgB;IAC9C,OAAO,4GAAI,CAAC,IAAI,CAAC,UAAU;AAC7B;AAEO,eAAe,aAAgB,QAAgB;IACpD,MAAM,WAAW,gBAAgB;IACjC,MAAM,eAAe,MAAM,gIAAE,CAAC,QAAQ,CAAC,UAAU;IACjD,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,cAAiB,QAAgB,EAAE,IAAO;IAC9D,MAAM,WAAW,gBAAgB;IAEjC,oDAAoD;IACpD,MAAO,MAAM,GAAG,CAAC,UAAW;QAC1B,MAAM,MAAM,GAAG,CAAC;IAClB;IAEA,6CAA6C;IAC7C,MAAM,YAAY,CAAC;QACjB,IAAI;YACF,MAAM,aAAa,KAAK,SAAS,CAAC,MAAM,MAAM;YAE9C,+BAA+B;YAC/B,IAAI;gBACF,KAAK,KAAK,CAAC;YACb,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,sCAAsC;gBACpD,MAAM,IAAI,MAAM;YAClB;YAEA,gEAAgE;YAChE,MAAM,eAAe,GAAG,SAAS,IAAI,CAAC;YACtC,MAAM,gIAAE,CAAC,SAAS,CAAC,cAAc,YAAY;YAC7C,MAAM,gIAAE,CAAC,MAAM,CAAC,cAAc;QAChC,SAAU;YACR,MAAM,MAAM,CAAC;QACf;IACF,CAAC;IAED,MAAM,GAAG,CAAC,UAAU;IACpB,MAAM;AACR"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/engagements.ts"],"sourcesContent":["import { readJsonFile, writeJsonFile } from \"@/lib/jsonDb\";\r\nimport type {\r\n  AssignmentRecord,\r\n  EngagementRecord,\r\n  ResponsibilityRecord,\r\n} from \"@/lib/data/schema\";\r\n\r\ninterface CourseFileRecord {\r\n  id: string;\r\n  facultyId: string;\r\n}\r\n\r\ninterface EventReportRecord {\r\n  id: string;\r\n  facultyId: string;\r\n}\r\n\r\ninterface EngagementCounts {\r\n  uploadsCount: number;\r\n  activityParticipationCount: number;\r\n  responsibilitiesCount: number;\r\n  courseCompletionCount: number;\r\n}\r\n\r\nfunction computeEngagementScore(counts: EngagementCounts) {\r\n  const uploadsPoints = counts.uploadsCount * 10;\r\n  const activityPoints = counts.activityParticipationCount * 15;\r\n  const responsibilityPoints = counts.responsibilitiesCount * 8;\r\n  const completionPoints = counts.courseCompletionCount * 20;\r\n  return Math.min(\r\n    100,\r\n    uploadsPoints + activityPoints + responsibilityPoints + completionPoints,\r\n  );\r\n}\r\n\r\nexport async function recomputeEngagementForFaculty(facultyId: string) {\r\n  const [\r\n    courseFiles,\r\n    eventReports,\r\n    responsibilities,\r\n    assignments,\r\n    engagements,\r\n  ] = await Promise.all([\r\n    readJsonFile<CourseFileRecord[]>(\"courseFiles.json\"),\r\n    readJsonFile<EventReportRecord[]>(\"eventReports.json\"),\r\n    readJsonFile<ResponsibilityRecord[]>(\"responsibilities.json\"),\r\n    readJsonFile<AssignmentRecord[]>(\"assignments.json\"),\r\n    readJsonFile<EngagementRecord[]>(\"engagements.json\"),\r\n  ]);\r\n\r\n  const uploadsCount = courseFiles.filter(\r\n    (file) => file.facultyId === facultyId,\r\n  ).length;\r\n  const activityParticipationCount = eventReports.filter(\r\n    (report) => report.facultyId === facultyId,\r\n  ).length;\r\n  const responsibilitiesCount = responsibilities.filter(\r\n    (responsibility) =>\r\n      responsibility.facultyId === facultyId &&\r\n      responsibility.status !== \"removed\",\r\n  ).length;\r\n  const courseCompletionCount = assignments.filter(\r\n    (assignment) =>\r\n      assignment.facultyId === facultyId && assignment.status === \"completed\",\r\n  ).length;\r\n\r\n  const score = computeEngagementScore({\r\n    uploadsCount,\r\n    activityParticipationCount,\r\n    responsibilitiesCount,\r\n    courseCompletionCount,\r\n  });\r\n  const updatedAt = new Date().toISOString();\r\n\r\n  const nextRecord: EngagementRecord = {\r\n    id: facultyId,\r\n    facultyId,\r\n    uploadsCount,\r\n    activityParticipationCount,\r\n    responsibilitiesCount,\r\n    courseCompletionCount,\r\n    score,\r\n    updatedAt,\r\n  };\r\n\r\n  const existingIndex = engagements.findIndex(\r\n    (entry) => entry.facultyId === facultyId,\r\n  );\r\n  const nextEngagements = [...engagements];\r\n\r\n  if (existingIndex >= 0) {\r\n    nextEngagements[existingIndex] = nextRecord;\r\n  } else {\r\n    nextEngagements.unshift(nextRecord);\r\n  }\r\n\r\n  await writeJsonFile(\"engagements.json\", nextEngagements);\r\n  return nextRecord;\r\n}\r\n\r\nexport async function recomputeAllEngagements() {\r\n  const users = await readJsonFile<{ id: string }[]>(\"users.json\");\r\n  const results = await Promise.all(\r\n    users.map((user) => recomputeEngagementForFaculty(user.id)),\r\n  );\r\n  return results;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAwBA,SAAS,uBAAuB,MAAwB;IACtD,MAAM,gBAAgB,OAAO,YAAY,GAAG;IAC5C,MAAM,iBAAiB,OAAO,0BAA0B,GAAG;IAC3D,MAAM,uBAAuB,OAAO,qBAAqB,GAAG;IAC5D,MAAM,mBAAmB,OAAO,qBAAqB,GAAG;IACxD,OAAO,KAAK,GAAG,CACb,KACA,gBAAgB,iBAAiB,uBAAuB;AAE5D;AAEO,eAAe,8BAA8B,SAAiB;IACnE,MAAM,CACJ,aACA,cACA,kBACA,aACA,YACD,GAAG,MAAM,QAAQ,GAAG,CAAC;QACpB,IAAA,sIAAY,EAAqB;QACjC,IAAA,sIAAY,EAAsB;QAClC,IAAA,sIAAY,EAAyB;QACrC,IAAA,sIAAY,EAAqB;QACjC,IAAA,sIAAY,EAAqB;KAClC;IAED,MAAM,eAAe,YAAY,MAAM,CACrC,CAAC,OAAS,KAAK,SAAS,KAAK,WAC7B,MAAM;IACR,MAAM,6BAA6B,aAAa,MAAM,CACpD,CAAC,SAAW,OAAO,SAAS,KAAK,WACjC,MAAM;IACR,MAAM,wBAAwB,iBAAiB,MAAM,CACnD,CAAC,iBACC,eAAe,SAAS,KAAK,aAC7B,eAAe,MAAM,KAAK,WAC5B,MAAM;IACR,MAAM,wBAAwB,YAAY,MAAM,CAC9C,CAAC,aACC,WAAW,SAAS,KAAK,aAAa,WAAW,MAAM,KAAK,aAC9D,MAAM;IAER,MAAM,QAAQ,uBAAuB;QACnC;QACA;QACA;QACA;IACF;IACA,MAAM,YAAY,IAAI,OAAO,WAAW;IAExC,MAAM,aAA+B;QACnC,IAAI;QACJ;QACA;QACA;QACA;QACA;QACA;QACA;IACF;IAEA,MAAM,gBAAgB,YAAY,SAAS,CACzC,CAAC,QAAU,MAAM,SAAS,KAAK;IAEjC,MAAM,kBAAkB;WAAI;KAAY;IAExC,IAAI,iBAAiB,GAAG;QACtB,eAAe,CAAC,cAAc,GAAG;IACnC,OAAO;QACL,gBAAgB,OAAO,CAAC;IAC1B;IAEA,MAAM,IAAA,uIAAa,EAAC,oBAAoB;IACxC,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,QAAQ,MAAM,IAAA,sIAAY,EAAmB;IACnD,MAAM,UAAU,MAAM,QAAQ,GAAG,CAC/B,MAAM,GAAG,CAAC,CAAC,OAAS,8BAA8B,KAAK,EAAE;IAE3D,OAAO;AACT"}},
    {"offset": {"line": 184, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/fileUpload.ts"],"sourcesContent":["import { mkdir, writeFile } from \"fs/promises\";\r\nimport { existsSync } from \"fs\";\r\nimport { join } from \"path\";\r\n\r\n/**\r\n * Creates a folder for the course code if it doesn't exist\r\n * and saves the file to that folder\r\n */\r\nexport async function saveCoursefile(\r\n  courseCode: string,\r\n  file: File,\r\n): Promise<string> {\r\n  try {\r\n    // Sanitize course code to ensure valid folder name\r\n    const sanitizedCourseCode = courseCode.replace(/[^a-zA-Z0-9-_]/g, \"_\");\r\n\r\n    if (!sanitizedCourseCode) {\r\n      throw new Error(\"Invalid course code\");\r\n    }\r\n\r\n    // Define the base upload directory\r\n    const baseUploadDir = join(\r\n      process.cwd(),\r\n      \"public\",\r\n      \"uploads\",\r\n      \"course-files\",\r\n    );\r\n\r\n    // Create the course code folder path\r\n    const courseFolder = join(baseUploadDir, sanitizedCourseCode);\r\n\r\n    // Create the base directory if it doesn't exist\r\n    if (!existsSync(baseUploadDir)) {\r\n      await mkdir(baseUploadDir, { recursive: true });\r\n    }\r\n\r\n    // Create the course code folder if it doesn't exist\r\n    if (!existsSync(courseFolder)) {\r\n      await mkdir(courseFolder, { recursive: true });\r\n    }\r\n\r\n    // Generate a unique filename with timestamp\r\n    const timestamp = Date.now();\r\n    const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, \"_\");\r\n    const fileName = `${timestamp}_${sanitizedFileName}`;\r\n    const filePath = join(courseFolder, fileName);\r\n\r\n    // Convert file to buffer and save\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    await writeFile(filePath, buffer);\r\n\r\n    // Return the public URL path\r\n    return `/uploads/course-files/${sanitizedCourseCode}/${fileName}`;\r\n  } catch (error) {\r\n    console.error(\"Error saving course file:\", error);\r\n    throw new Error(\"Failed to save course file\");\r\n  }\r\n}\r\n\r\n/**\r\n * Converts a data URL to a file path by extracting the base64 data\r\n * and saving it to the appropriate folder\r\n */\r\nexport async function saveDataUrlAsFile(\r\n  courseCode: string,\r\n  fileName: string,\r\n  dataUrl: string,\r\n): Promise<string> {\r\n  try {\r\n    // Sanitize course code to ensure valid folder name\r\n    const sanitizedCourseCode = courseCode.replace(/[^a-zA-Z0-9-_]/g, \"_\");\r\n\r\n    console.log(`Original course code: \"${courseCode}\"`);\r\n    console.log(`Sanitized course code: \"${sanitizedCourseCode}\"`);\r\n\r\n    if (!sanitizedCourseCode) {\r\n      throw new Error(\"Invalid course code\");\r\n    }\r\n\r\n    // Define the base upload directory\r\n    const baseUploadDir = join(\r\n      process.cwd(),\r\n      \"public\",\r\n      \"uploads\",\r\n      \"course-files\",\r\n    );\r\n\r\n    // Create the course code folder path\r\n    const courseFolder = join(baseUploadDir, sanitizedCourseCode);\r\n\r\n    console.log(`Creating folder: ${courseFolder}`);\r\n\r\n    // Create the base directory if it doesn't exist\r\n    if (!existsSync(baseUploadDir)) {\r\n      console.log(`Creating base upload directory: ${baseUploadDir}`);\r\n      await mkdir(baseUploadDir, { recursive: true });\r\n    }\r\n\r\n    // Create the course code folder if it doesn't exist\r\n    if (!existsSync(courseFolder)) {\r\n      console.log(`Creating course folder: ${courseFolder}`);\r\n      await mkdir(courseFolder, { recursive: true });\r\n    } else {\r\n      console.log(`Course folder already exists: ${courseFolder}`);\r\n    }\r\n\r\n    // Extract base64 data from data URL\r\n    const matches = dataUrl.match(/^data:([A-Za-z-+\\/]+);base64,(.+)$/);\r\n    if (!matches || matches.length !== 3) {\r\n      throw new Error(\"Invalid data URL\");\r\n    }\r\n\r\n    const base64Data = matches[2];\r\n    const buffer = Buffer.from(base64Data, \"base64\");\r\n\r\n    // Generate a unique filename with timestamp\r\n    const timestamp = Date.now();\r\n    const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9.-]/g, \"_\");\r\n    const newFileName = `${timestamp}_${sanitizedFileName}`;\r\n    const filePath = join(courseFolder, newFileName);\r\n\r\n    console.log(`Saving file to: ${filePath}`);\r\n\r\n    // Save the file\r\n    await writeFile(filePath, buffer);\r\n\r\n    console.log(`File saved successfully, size: ${buffer.length} bytes`);\r\n\r\n    // Return the public URL path\r\n    const publicUrl = `/uploads/course-files/${sanitizedCourseCode}/${newFileName}`;\r\n    console.log(`Public URL: ${publicUrl}`);\r\n    return publicUrl;\r\n  } catch (error) {\r\n    console.error(\"Error saving data URL as file:\", error);\r\n    throw new Error(\"Failed to save file from data URL\");\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 294, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/app/api/course-files/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { readJsonFile, writeJsonFile } from \"@/lib/jsonDb\";\r\nimport type { CourseFile } from \"@/components/CourseFileManager/types\";\r\nimport { recomputeEngagementForFaculty } from \"@/lib/engagements\";\r\nimport { saveDataUrlAsFile } from \"@/lib/fileUpload\";\r\n\r\n// Force Node.js runtime for file system operations\r\nexport const runtime = \"nodejs\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const payload = await request.json();\r\n\r\n    // Validate required fields\r\n    if (!payload.courseCode) {\r\n      return NextResponse.json(\r\n        { error: \"Course code is required\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    if (!payload.fileName) {\r\n      return NextResponse.json(\r\n        { error: \"File name is required\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    const files = await readJsonFile<CourseFile[]>(\"courseFiles.json\");\r\n    const users =\r\n      await readJsonFile<{ id: string; name: string; department?: string }[]>(\r\n        \"users.json\",\r\n      );\r\n    const facultyUser = users.find((user) => user.id === payload.facultyId);\r\n    const timestamp = new Date().toISOString();\r\n\r\n    // Save file to course code folder and get the file path\r\n    let documentUrl = payload.documentUrl;\r\n    if (payload.documentUrl && payload.documentUrl.startsWith(\"data:\")) {\r\n      try {\r\n        console.log(`Saving file for course code: ${payload.courseCode}`);\r\n        documentUrl = await saveDataUrlAsFile(\r\n          payload.courseCode,\r\n          payload.fileName,\r\n          payload.documentUrl,\r\n        );\r\n        console.log(`File saved successfully: ${documentUrl}`);\r\n      } catch (error) {\r\n        console.error(\"Error saving file to folder:\", error);\r\n        // Return error instead of falling back - we want to know if this fails\r\n        return NextResponse.json(\r\n          { error: \"Failed to save file to disk\" },\r\n          { status: 500 },\r\n        );\r\n      }\r\n    }\r\n\r\n    const newFile: CourseFile = {\r\n      id: Date.now().toString(),\r\n      facultyId: payload.facultyId,\r\n      fileName: payload.fileName,\r\n      documentUrl: documentUrl,\r\n      courseCode: payload.courseCode,\r\n      courseName: payload.courseName,\r\n      fileType: payload.fileType,\r\n      uploadDate: payload.uploadDate,\r\n      semester: payload.semester,\r\n      academicYear: payload.academicYear,\r\n      size: payload.size,\r\n      status: payload.status ?? \"Pending\",\r\n      facultyName: facultyUser?.name ?? payload.facultyName,\r\n      department: facultyUser?.department ?? payload.department,\r\n      createdAt: timestamp,\r\n      updatedAt: timestamp,\r\n    };\r\n\r\n    const updatedFiles = [newFile, ...files];\r\n\r\n    try {\r\n      console.log(\"Writing to courseFiles.json...\");\r\n      await writeJsonFile(\"courseFiles.json\", updatedFiles);\r\n      console.log(\"courseFiles.json updated successfully\");\r\n    } catch (error) {\r\n      console.error(\"Error writing courseFiles.json:\", error);\r\n      return NextResponse.json(\r\n        { error: \"Failed to save file metadata\" },\r\n        { status: 500 },\r\n      );\r\n    }\r\n\r\n    // Recompute engagement after file upload\r\n    if (payload.facultyId) {\r\n      try {\r\n        console.log(`Recomputing engagement for faculty: ${payload.facultyId}`);\r\n        await recomputeEngagementForFaculty(payload.facultyId);\r\n        console.log(\"Engagement recomputed successfully\");\r\n      } catch (error) {\r\n        console.error(\"Error recomputing engagement:\", error);\r\n        // Don't fail the upload if engagement computation fails\r\n        // The file is already saved and added to the database\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ files: updatedFiles });\r\n  } catch (error) {\r\n    console.error(\"Course file create error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to create course file\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function GET() {\r\n  try {\r\n    const files = await readJsonFile<CourseFile[]>(\"courseFiles.json\");\r\n    const users =\r\n      await readJsonFile<{ id: string; name: string; department?: string }[]>(\r\n        \"users.json\",\r\n      );\r\n    const fileCategories = await readJsonFile<string[]>(\r\n      \"files/course-file-categories.json\",\r\n    );\r\n    const fileTypes = await readJsonFile<string[]>(\r\n      \"files/course-file-types.json\",\r\n    );\r\n    const filesWithFaculty = files.map((file) => {\r\n      const facultyUser = users.find((user) => user.id === file.facultyId);\r\n      return {\r\n        ...file,\r\n        facultyName: facultyUser?.name ?? file.facultyName,\r\n        department: facultyUser?.department ?? file.department,\r\n      };\r\n    });\r\n    return NextResponse.json({\r\n      files: filesWithFaculty,\r\n      fileCategories,\r\n      fileTypes,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Course file load error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to load course files\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AAEA;AACA;;;;;AAGO,MAAM,UAAU;AAEhB,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,UAAU,MAAM,QAAQ,IAAI;QAElC,2BAA2B;QAC3B,IAAI,CAAC,QAAQ,UAAU,EAAE;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,QAAQ,QAAQ,EAAE;YACrB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwB,GACjC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,MAAM,IAAA,sIAAY,EAAe;QAC/C,MAAM,QACJ,MAAM,IAAA,sIAAY,EAChB;QAEJ,MAAM,cAAc,MAAM,IAAI,CAAC,CAAC,OAAS,KAAK,EAAE,KAAK,QAAQ,SAAS;QACtE,MAAM,YAAY,IAAI,OAAO,WAAW;QAExC,wDAAwD;QACxD,IAAI,cAAc,QAAQ,WAAW;QACrC,IAAI,QAAQ,WAAW,IAAI,QAAQ,WAAW,CAAC,UAAU,CAAC,UAAU;YAClE,IAAI;gBACF,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,QAAQ,UAAU,EAAE;gBAChE,cAAc,MAAM,IAAA,+IAAiB,EACnC,QAAQ,UAAU,EAClB,QAAQ,QAAQ,EAChB,QAAQ,WAAW;gBAErB,QAAQ,GAAG,CAAC,CAAC,yBAAyB,EAAE,aAAa;YACvD,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,gCAAgC;gBAC9C,uEAAuE;gBACvE,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;gBAA8B,GACvC;oBAAE,QAAQ;gBAAI;YAElB;QACF;QAEA,MAAM,UAAsB;YAC1B,IAAI,KAAK,GAAG,GAAG,QAAQ;YACvB,WAAW,QAAQ,SAAS;YAC5B,UAAU,QAAQ,QAAQ;YAC1B,aAAa;YACb,YAAY,QAAQ,UAAU;YAC9B,YAAY,QAAQ,UAAU;YAC9B,UAAU,QAAQ,QAAQ;YAC1B,YAAY,QAAQ,UAAU;YAC9B,UAAU,QAAQ,QAAQ;YAC1B,cAAc,QAAQ,YAAY;YAClC,MAAM,QAAQ,IAAI;YAClB,QAAQ,QAAQ,MAAM,IAAI;YAC1B,aAAa,aAAa,QAAQ,QAAQ,WAAW;YACrD,YAAY,aAAa,cAAc,QAAQ,UAAU;YACzD,WAAW;YACX,WAAW;QACb;QAEA,MAAM,eAAe;YAAC;eAAY;SAAM;QAExC,IAAI;YACF,QAAQ,GAAG,CAAC;YACZ,MAAM,IAAA,uIAAa,EAAC,oBAAoB;YACxC,QAAQ,GAAG,CAAC;QACd,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,mCAAmC;YACjD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA,yCAAyC;QACzC,IAAI,QAAQ,SAAS,EAAE;YACrB,IAAI;gBACF,QAAQ,GAAG,CAAC,CAAC,oCAAoC,EAAE,QAAQ,SAAS,EAAE;gBACtE,MAAM,IAAA,4JAA6B,EAAC,QAAQ,SAAS;gBACrD,QAAQ,GAAG,CAAC;YACd,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,wDAAwD;YACxD,sDAAsD;YACxD;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAa;IACjD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA+B,GACxC;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,QAAQ,MAAM,IAAA,sIAAY,EAAe;QAC/C,MAAM,QACJ,MAAM,IAAA,sIAAY,EAChB;QAEJ,MAAM,iBAAiB,MAAM,IAAA,sIAAY,EACvC;QAEF,MAAM,YAAY,MAAM,IAAA,sIAAY,EAClC;QAEF,MAAM,mBAAmB,MAAM,GAAG,CAAC,CAAC;YAClC,MAAM,cAAc,MAAM,IAAI,CAAC,CAAC,OAAS,KAAK,EAAE,KAAK,KAAK,SAAS;YACnE,OAAO;gBACL,GAAG,IAAI;gBACP,aAAa,aAAa,QAAQ,KAAK,WAAW;gBAClD,YAAY,aAAa,cAAc,KAAK,UAAU;YACxD;QACF;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;YACP;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA8B,GACvC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}