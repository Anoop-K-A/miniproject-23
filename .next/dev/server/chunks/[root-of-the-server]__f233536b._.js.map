{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/jsonDb.ts"],"sourcesContent":["import fs from \"fs/promises\";\r\nimport path from \"path\";\r\n\r\nconst dataRoot = path.join(process.cwd(), \"src\", \"data\");\r\n\r\n// Simple lock mechanism to prevent concurrent writes\r\nconst locks = new Map<string, Promise<void>>();\r\n\r\nexport function getDataFilePath(fileName: string) {\r\n  return path.join(dataRoot, fileName);\r\n}\r\n\r\nexport async function readJsonFile<T>(fileName: string): Promise<T> {\r\n  const filePath = getDataFilePath(fileName);\r\n  const fileContents = await fs.readFile(filePath, \"utf-8\");\r\n  return JSON.parse(fileContents) as T;\r\n}\r\n\r\nexport async function writeJsonFile<T>(fileName: string, data: T) {\r\n  const filePath = getDataFilePath(fileName);\r\n\r\n  // Wait for any existing write operation to complete\r\n  while (locks.has(fileName)) {\r\n    await locks.get(fileName);\r\n  }\r\n\r\n  // Create a new lock for this write operation\r\n  const writeLock = (async () => {\r\n    try {\r\n      const jsonString = JSON.stringify(data, null, 2);\r\n\r\n      // Validate JSON before writing\r\n      try {\r\n        JSON.parse(jsonString);\r\n      } catch (error) {\r\n        console.error(\"Invalid JSON data, aborting write:\", error);\r\n        throw new Error(\"Failed to write JSON: Invalid data structure\");\r\n      }\r\n\r\n      // Write to temporary file first, then rename (atomic operation)\r\n      const tempFilePath = `${filePath}.tmp`;\r\n      await fs.writeFile(tempFilePath, jsonString, \"utf-8\");\r\n      await fs.rename(tempFilePath, filePath);\r\n    } finally {\r\n      locks.delete(fileName);\r\n    }\r\n  })();\r\n\r\n  locks.set(fileName, writeLock);\r\n  await writeLock;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEA,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,OAAO;AAEjD,qDAAqD;AACrD,MAAM,QAAQ,IAAI;AAEX,SAAS,gBAAgB,QAAgB;IAC9C,OAAO,4GAAI,CAAC,IAAI,CAAC,UAAU;AAC7B;AAEO,eAAe,aAAgB,QAAgB;IACpD,MAAM,WAAW,gBAAgB;IACjC,MAAM,eAAe,MAAM,gIAAE,CAAC,QAAQ,CAAC,UAAU;IACjD,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,cAAiB,QAAgB,EAAE,IAAO;IAC9D,MAAM,WAAW,gBAAgB;IAEjC,oDAAoD;IACpD,MAAO,MAAM,GAAG,CAAC,UAAW;QAC1B,MAAM,MAAM,GAAG,CAAC;IAClB;IAEA,6CAA6C;IAC7C,MAAM,YAAY,CAAC;QACjB,IAAI;YACF,MAAM,aAAa,KAAK,SAAS,CAAC,MAAM,MAAM;YAE9C,+BAA+B;YAC/B,IAAI;gBACF,KAAK,KAAK,CAAC;YACb,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,sCAAsC;gBACpD,MAAM,IAAI,MAAM;YAClB;YAEA,gEAAgE;YAChE,MAAM,eAAe,GAAG,SAAS,IAAI,CAAC;YACtC,MAAM,gIAAE,CAAC,SAAS,CAAC,cAAc,YAAY;YAC7C,MAAM,gIAAE,CAAC,MAAM,CAAC,cAAc;QAChC,SAAU;YACR,MAAM,MAAM,CAAC;QACf;IACF,CAAC;IAED,MAAM,GAAG,CAAC,UAAU;IACpB,MAAM;AACR"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/engagements.ts"],"sourcesContent":["import { readJsonFile, writeJsonFile } from \"@/lib/jsonDb\";\r\nimport type {\r\n  AssignmentRecord,\r\n  EngagementRecord,\r\n  ResponsibilityRecord,\r\n} from \"@/lib/data/schema\";\r\n\r\ninterface CourseFileRecord {\r\n  id: string;\r\n  facultyId: string;\r\n}\r\n\r\ninterface EventReportRecord {\r\n  id: string;\r\n  facultyId: string;\r\n}\r\n\r\ninterface EngagementCounts {\r\n  uploadsCount: number;\r\n  activityParticipationCount: number;\r\n  responsibilitiesCount: number;\r\n  courseCompletionCount: number;\r\n}\r\n\r\nfunction computeEngagementScore(counts: EngagementCounts) {\r\n  const uploadsPoints = counts.uploadsCount * 10;\r\n  const activityPoints = counts.activityParticipationCount * 15;\r\n  const responsibilityPoints = counts.responsibilitiesCount * 8;\r\n  const completionPoints = counts.courseCompletionCount * 20;\r\n  return Math.min(\r\n    100,\r\n    uploadsPoints + activityPoints + responsibilityPoints + completionPoints,\r\n  );\r\n}\r\n\r\nexport async function recomputeEngagementForFaculty(facultyId: string) {\r\n  const [\r\n    courseFiles,\r\n    eventReports,\r\n    responsibilities,\r\n    assignments,\r\n    engagements,\r\n  ] = await Promise.all([\r\n    readJsonFile<CourseFileRecord[]>(\"courseFiles.json\"),\r\n    readJsonFile<EventReportRecord[]>(\"eventReports.json\"),\r\n    readJsonFile<ResponsibilityRecord[]>(\"responsibilities.json\"),\r\n    readJsonFile<AssignmentRecord[]>(\"assignments.json\"),\r\n    readJsonFile<EngagementRecord[]>(\"engagements.json\"),\r\n  ]);\r\n\r\n  const uploadsCount = courseFiles.filter(\r\n    (file) => file.facultyId === facultyId,\r\n  ).length;\r\n  const activityParticipationCount = eventReports.filter(\r\n    (report) => report.facultyId === facultyId,\r\n  ).length;\r\n  const responsibilitiesCount = responsibilities.filter(\r\n    (responsibility) =>\r\n      responsibility.facultyId === facultyId &&\r\n      responsibility.status !== \"removed\",\r\n  ).length;\r\n  const courseCompletionCount = assignments.filter(\r\n    (assignment) =>\r\n      assignment.facultyId === facultyId && assignment.status === \"completed\",\r\n  ).length;\r\n\r\n  const score = computeEngagementScore({\r\n    uploadsCount,\r\n    activityParticipationCount,\r\n    responsibilitiesCount,\r\n    courseCompletionCount,\r\n  });\r\n  const updatedAt = new Date().toISOString();\r\n\r\n  const nextRecord: EngagementRecord = {\r\n    id: facultyId,\r\n    facultyId,\r\n    uploadsCount,\r\n    activityParticipationCount,\r\n    responsibilitiesCount,\r\n    courseCompletionCount,\r\n    score,\r\n    updatedAt,\r\n  };\r\n\r\n  const existingIndex = engagements.findIndex(\r\n    (entry) => entry.facultyId === facultyId,\r\n  );\r\n  const nextEngagements = [...engagements];\r\n\r\n  if (existingIndex >= 0) {\r\n    nextEngagements[existingIndex] = nextRecord;\r\n  } else {\r\n    nextEngagements.unshift(nextRecord);\r\n  }\r\n\r\n  await writeJsonFile(\"engagements.json\", nextEngagements);\r\n  return nextRecord;\r\n}\r\n\r\nexport async function recomputeAllEngagements() {\r\n  const users = await readJsonFile<{ id: string }[]>(\"users.json\");\r\n  const results: EngagementRecord[] = [];\r\n  for (const user of users) {\r\n    results.push(await recomputeEngagementForFaculty(user.id));\r\n  }\r\n  return results;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAwBA,SAAS,uBAAuB,MAAwB;IACtD,MAAM,gBAAgB,OAAO,YAAY,GAAG;IAC5C,MAAM,iBAAiB,OAAO,0BAA0B,GAAG;IAC3D,MAAM,uBAAuB,OAAO,qBAAqB,GAAG;IAC5D,MAAM,mBAAmB,OAAO,qBAAqB,GAAG;IACxD,OAAO,KAAK,GAAG,CACb,KACA,gBAAgB,iBAAiB,uBAAuB;AAE5D;AAEO,eAAe,8BAA8B,SAAiB;IACnE,MAAM,CACJ,aACA,cACA,kBACA,aACA,YACD,GAAG,MAAM,QAAQ,GAAG,CAAC;QACpB,IAAA,sIAAY,EAAqB;QACjC,IAAA,sIAAY,EAAsB;QAClC,IAAA,sIAAY,EAAyB;QACrC,IAAA,sIAAY,EAAqB;QACjC,IAAA,sIAAY,EAAqB;KAClC;IAED,MAAM,eAAe,YAAY,MAAM,CACrC,CAAC,OAAS,KAAK,SAAS,KAAK,WAC7B,MAAM;IACR,MAAM,6BAA6B,aAAa,MAAM,CACpD,CAAC,SAAW,OAAO,SAAS,KAAK,WACjC,MAAM;IACR,MAAM,wBAAwB,iBAAiB,MAAM,CACnD,CAAC,iBACC,eAAe,SAAS,KAAK,aAC7B,eAAe,MAAM,KAAK,WAC5B,MAAM;IACR,MAAM,wBAAwB,YAAY,MAAM,CAC9C,CAAC,aACC,WAAW,SAAS,KAAK,aAAa,WAAW,MAAM,KAAK,aAC9D,MAAM;IAER,MAAM,QAAQ,uBAAuB;QACnC;QACA;QACA;QACA;IACF;IACA,MAAM,YAAY,IAAI,OAAO,WAAW;IAExC,MAAM,aAA+B;QACnC,IAAI;QACJ;QACA;QACA;QACA;QACA;QACA;QACA;IACF;IAEA,MAAM,gBAAgB,YAAY,SAAS,CACzC,CAAC,QAAU,MAAM,SAAS,KAAK;IAEjC,MAAM,kBAAkB;WAAI;KAAY;IAExC,IAAI,iBAAiB,GAAG;QACtB,eAAe,CAAC,cAAc,GAAG;IACnC,OAAO;QACL,gBAAgB,OAAO,CAAC;IAC1B;IAEA,MAAM,IAAA,uIAAa,EAAC,oBAAoB;IACxC,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,QAAQ,MAAM,IAAA,sIAAY,EAAmB;IACnD,MAAM,UAA8B,EAAE;IACtC,KAAK,MAAM,QAAQ,MAAO;QACxB,QAAQ,IAAI,CAAC,MAAM,8BAA8B,KAAK,EAAE;IAC1D;IACA,OAAO;AACT"}},
    {"offset": {"line": 181, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/app/api/engagements/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { readJsonFile } from \"@/lib/jsonDb\";\r\nimport { recomputeAllEngagements } from \"@/lib/engagements\";\r\nimport type { EngagementRecord } from \"@/lib/data/schema\";\r\n\r\ninterface CourseFileRecord {\r\n  id: string;\r\n  facultyId: string;\r\n}\r\n\r\ninterface EventReportRecord {\r\n  id: string;\r\n  facultyId: string;\r\n}\r\n\r\nexport async function GET() {\r\n  try {\r\n    const [engagements, courseFiles, eventReports] = await Promise.all([\r\n      readJsonFile<EngagementRecord[]>(\"engagements.json\").catch(() => []),\r\n      readJsonFile<CourseFileRecord[]>(\"courseFiles.json\").catch(() => []),\r\n      readJsonFile<EventReportRecord[]>(\"eventReports.json\").catch(() => []),\r\n    ]);\r\n\r\n    return NextResponse.json({\r\n      engagements,\r\n      courseFilesCount: courseFiles.length,\r\n      eventReportsCount: eventReports.length,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Engagement load error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to load engagement data\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST() {\r\n  try {\r\n    console.log(\"Recomputing engagement for all users...\");\r\n    const results = await recomputeAllEngagements();\r\n    console.log(`Engagement recomputed for ${results.length} users`);\r\n\r\n    return NextResponse.json({\r\n      message: `Engagement scores recomputed for ${results.length} users`,\r\n      engagements: results,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Engagement recomputation error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Unknown recomputation error\";\r\n    return NextResponse.json(\r\n      { error: \"Failed to recompute engagement scores\", message },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAaO,eAAe;IACpB,IAAI;QACF,MAAM,CAAC,aAAa,aAAa,aAAa,GAAG,MAAM,QAAQ,GAAG,CAAC;YACjE,IAAA,sIAAY,EAAqB,oBAAoB,KAAK,CAAC,IAAM,EAAE;YACnE,IAAA,sIAAY,EAAqB,oBAAoB,KAAK,CAAC,IAAM,EAAE;YACnE,IAAA,sIAAY,EAAsB,qBAAqB,KAAK,CAAC,IAAM,EAAE;SACtE;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB;YACA,kBAAkB,YAAY,MAAM;YACpC,mBAAmB,aAAa,MAAM;QACxC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAiC,GAC1C;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe;IACpB,IAAI;QACF,QAAQ,GAAG,CAAC;QACZ,MAAM,UAAU,MAAM,IAAA,sJAAuB;QAC7C,QAAQ,GAAG,CAAC,CAAC,0BAA0B,EAAE,QAAQ,MAAM,CAAC,MAAM,CAAC;QAE/D,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS,CAAC,iCAAiC,EAAE,QAAQ,MAAM,CAAC,MAAM,CAAC;YACnE,aAAa;QACf;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAyC;QAAQ,GAC1D;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}