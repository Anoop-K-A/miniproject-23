{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/jsonDb.ts"],"sourcesContent":["import fs from \"fs/promises\";\r\nimport path from \"path\";\r\n\r\nconst dataRoot = path.join(process.cwd(), \"src\", \"data\");\r\n\r\n// Simple lock mechanism to prevent concurrent writes\r\nconst locks = new Map<string, Promise<void>>();\r\n\r\nexport function getDataFilePath(fileName: string) {\r\n  return path.join(dataRoot, fileName);\r\n}\r\n\r\nexport async function readJsonFile<T>(fileName: string): Promise<T> {\r\n  const filePath = getDataFilePath(fileName);\r\n  const fileContents = await fs.readFile(filePath, \"utf-8\");\r\n  return JSON.parse(fileContents) as T;\r\n}\r\n\r\nexport async function writeJsonFile<T>(fileName: string, data: T) {\r\n  const filePath = getDataFilePath(fileName);\r\n\r\n  // Wait for any existing write operation to complete\r\n  while (locks.has(fileName)) {\r\n    await locks.get(fileName);\r\n  }\r\n\r\n  // Create a new lock for this write operation\r\n  const writeLock = (async () => {\r\n    try {\r\n      const jsonString = JSON.stringify(data, null, 2);\r\n\r\n      // Validate JSON before writing\r\n      try {\r\n        JSON.parse(jsonString);\r\n      } catch (error) {\r\n        console.error(\"Invalid JSON data, aborting write:\", error);\r\n        throw new Error(\"Failed to write JSON: Invalid data structure\");\r\n      }\r\n\r\n      // Write to temporary file first, then rename (atomic operation)\r\n      const tempFilePath = `${filePath}.tmp`;\r\n      await fs.writeFile(tempFilePath, jsonString, \"utf-8\");\r\n      await fs.rename(tempFilePath, filePath);\r\n    } finally {\r\n      locks.delete(fileName);\r\n    }\r\n  })();\r\n\r\n  locks.set(fileName, writeLock);\r\n  await writeLock;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEA,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,OAAO;AAEjD,qDAAqD;AACrD,MAAM,QAAQ,IAAI;AAEX,SAAS,gBAAgB,QAAgB;IAC9C,OAAO,4GAAI,CAAC,IAAI,CAAC,UAAU;AAC7B;AAEO,eAAe,aAAgB,QAAgB;IACpD,MAAM,WAAW,gBAAgB;IACjC,MAAM,eAAe,MAAM,gIAAE,CAAC,QAAQ,CAAC,UAAU;IACjD,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,cAAiB,QAAgB,EAAE,IAAO;IAC9D,MAAM,WAAW,gBAAgB;IAEjC,oDAAoD;IACpD,MAAO,MAAM,GAAG,CAAC,UAAW;QAC1B,MAAM,MAAM,GAAG,CAAC;IAClB;IAEA,6CAA6C;IAC7C,MAAM,YAAY,CAAC;QACjB,IAAI;YACF,MAAM,aAAa,KAAK,SAAS,CAAC,MAAM,MAAM;YAE9C,+BAA+B;YAC/B,IAAI;gBACF,KAAK,KAAK,CAAC;YACb,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,sCAAsC;gBACpD,MAAM,IAAI,MAAM;YAClB;YAEA,gEAAgE;YAChE,MAAM,eAAe,GAAG,SAAS,IAAI,CAAC;YACtC,MAAM,gIAAE,CAAC,SAAS,CAAC,cAAc,YAAY;YAC7C,MAAM,gIAAE,CAAC,MAAM,CAAC,cAAc;QAChC,SAAU;YACR,MAAM,MAAM,CAAC;QACf;IACF,CAAC;IAED,MAAM,GAAG,CAAC,UAAU;IACpB,MAAM;AACR"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/lib/auth.ts"],"sourcesContent":["import type { UserRole } from \"@/lib/roles\";\r\nimport { readJsonFile } from \"@/lib/jsonDb\";\r\n\r\nexport interface UserRecord {\r\n  id: string;\r\n  username: string;\r\n  password: string;\r\n  name: string;\r\n  role: UserRole;\r\n  roles?: UserRole[];\r\n  department?: string;\r\n  status?: string;\r\n  createdAt?: string;\r\n  updatedAt?: string;\r\n}\r\n\r\nexport interface AuthUser {\r\n  id: string;\r\n  username: string;\r\n  name: string;\r\n  role: UserRole;\r\n  roles?: UserRole[];\r\n  department?: string;\r\n}\r\n\r\nexport interface AuthResult {\r\n  user: AuthUser;\r\n  status?: string;\r\n}\r\n\r\nexport async function findUserByUsername(username: string) {\r\n  const users = await readJsonFile<UserRecord[]>(\"users.json\");\r\n  return users.find((user) => user.username === username);\r\n}\r\n\r\nexport async function verifyCredentials(username: string, password: string) {\r\n  const user = await findUserByUsername(username);\r\n  if (!user || user.password !== password) {\r\n    return null;\r\n  }\r\n\r\n  const { id, name, role, roles, department } = user;\r\n  return {\r\n    user: {\r\n      id,\r\n      username: user.username,\r\n      name,\r\n      role,\r\n      roles: roles || [role],\r\n      department,\r\n    },\r\n    status: user.status,\r\n  } satisfies AuthResult;\r\n}\r\n"],"names":[],"mappings":";;;;;;AACA;;AA6BO,eAAe,mBAAmB,QAAgB;IACvD,MAAM,QAAQ,MAAM,IAAA,sIAAY,EAAe;IAC/C,OAAO,MAAM,IAAI,CAAC,CAAC,OAAS,KAAK,QAAQ,KAAK;AAChD;AAEO,eAAe,kBAAkB,QAAgB,EAAE,QAAgB;IACxE,MAAM,OAAO,MAAM,mBAAmB;IACtC,IAAI,CAAC,QAAQ,KAAK,QAAQ,KAAK,UAAU;QACvC,OAAO;IACT;IAEA,MAAM,EAAE,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,UAAU,EAAE,GAAG;IAC9C,OAAO;QACL,MAAM;YACJ;YACA,UAAU,KAAK,QAAQ;YACvB;YACA;YACA,OAAO,SAAS;gBAAC;aAAK;YACtB;QACF;QACA,QAAQ,KAAK,MAAM;IACrB;AACF"}},
    {"offset": {"line": 149, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/anoop/miniproject-23/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { verifyCredentials } from \"@/lib/auth\";\r\nimport { readJsonFile, writeJsonFile } from \"@/lib/jsonDb\";\r\n\r\ninterface UserRecord {\r\n  id: string;\r\n  lastActiveAt?: string;\r\n  [key: string]: any;\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { email, password } = await request.json();\r\n\r\n    // Validate inputs\r\n    if (!email || !password) {\r\n      return NextResponse.json(\r\n        { error: \"Email and password are required\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    const result = await verifyCredentials(email, password);\r\n    if (!result) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid credentials\" },\r\n        { status: 401 },\r\n      );\r\n    }\r\n\r\n    const normalizedStatus = result.status?.toLowerCase();\r\n    const isApproved =\r\n      !normalizedStatus ||\r\n      normalizedStatus === \"active\" ||\r\n      normalizedStatus === \"approved\" ||\r\n      normalizedStatus === \"approval\";\r\n\r\n    if (!isApproved) {\r\n      return NextResponse.json(\r\n        { error: \"Account pending approval\" },\r\n        { status: 403 },\r\n      );\r\n    }\r\n\r\n    // Update lastActiveAt timestamp\r\n    try {\r\n      const users = await readJsonFile<UserRecord[]>(\"users.json\");\r\n      const updatedUsers = users.map((user) =>\r\n        user.id === result.user.id\r\n          ? { ...user, lastActiveAt: new Date().toISOString() }\r\n          : user,\r\n      );\r\n      await writeJsonFile(\"users.json\", updatedUsers);\r\n    } catch (error) {\r\n      console.error(\"Failed to update lastActiveAt:\", error);\r\n      // Continue with response even if this fails\r\n    }\r\n\r\n    return NextResponse.json({\r\n      id: result.user.id,\r\n      username: result.user.username,\r\n      name: result.user.name,\r\n      role: result.user.role,\r\n      roles: result.user.roles || [result.user.role],\r\n      department: result.user.department,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Login error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAQO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE9C,kBAAkB;QAClB,IAAI,CAAC,SAAS,CAAC,UAAU;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAkC,GAC3C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MAAM,IAAA,yIAAiB,EAAC,OAAO;QAC9C,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,mBAAmB,OAAO,MAAM,EAAE;QACxC,MAAM,aACJ,CAAC,oBACD,qBAAqB,YACrB,qBAAqB,cACrB,qBAAqB;QAEvB,IAAI,CAAC,YAAY;YACf,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA2B,GACpC;gBAAE,QAAQ;YAAI;QAElB;QAEA,gCAAgC;QAChC,IAAI;YACF,MAAM,QAAQ,MAAM,IAAA,sIAAY,EAAe;YAC/C,MAAM,eAAe,MAAM,GAAG,CAAC,CAAC,OAC9B,KAAK,EAAE,KAAK,OAAO,IAAI,CAAC,EAAE,GACtB;oBAAE,GAAG,IAAI;oBAAE,cAAc,IAAI,OAAO,WAAW;gBAAG,IAClD;YAEN,MAAM,IAAA,uIAAa,EAAC,cAAc;QACpC,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,4CAA4C;QAC9C;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,IAAI,OAAO,IAAI,CAAC,EAAE;YAClB,UAAU,OAAO,IAAI,CAAC,QAAQ;YAC9B,MAAM,OAAO,IAAI,CAAC,IAAI;YACtB,MAAM,OAAO,IAAI,CAAC,IAAI;YACtB,OAAO,OAAO,IAAI,CAAC,KAAK,IAAI;gBAAC,OAAO,IAAI,CAAC,IAAI;aAAC;YAC9C,YAAY,OAAO,IAAI,CAAC,UAAU;QACpC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}